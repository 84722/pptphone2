<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <!-- 优化视口设置，确保高清显示 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>集团宣传册</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: #f5f5f5;
      font-family: Arial, sans-serif;
    }
    
    #viewer {
      width: 100%;
      text-align: center;
      overflow-x: hidden;
    }
    
    .loading, .error {
      padding: 40px 20px;
      text-align: center;
    }
    
    .loading {
      color: #666;
    }
    
    .error {
      color: #dc3545;
    }
    
    canvas {
      /* CSS宽度占满屏幕，实际像素由JS控制 */
      width: 100% !important;
      height: auto !important;
      margin-bottom: 8px;
      background: #fff;
      display: block;
    }
    
    .page-info {
      color: #666;
      padding: 10px;
      text-align: center;
      background: #fff;
    }
  </style>
</head>
<body>
  <div id="viewer">
    <div class="loading">正在加载PDF文件，请稍候...</div>
  </div>
  <script>
    const url = "ttpdf.pdf";
    const viewer = document.getElementById('viewer');

    if (typeof pdfjsLib === 'undefined') {
      viewer.innerHTML = '<div class="error">PDF查看器加载失败，请刷新页面重试</div>';
    } else {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

      // 获取设备像素比（解决高清屏模糊问题）
      const devicePixelRatio = window.devicePixelRatio || 1;
      // 限制最大像素比（平衡清晰度和性能）
      const maxPixelRatio = 2;
      const effectivePixelRatio = Math.min(devicePixelRatio, maxPixelRatio);

      pdfjsLib.getDocument(url).promise
        .then(pdf => {
          viewer.innerHTML = '';
          
          // 显示总页数
          const pageInfo = document.createElement('div');
          pageInfo.className = 'page-info';
          pageInfo.textContent = `共 ${pdf.numPages} 页`;
          viewer.appendChild(pageInfo);
          
          // 计算适合屏幕的缩放比例（考虑像素密度）
          const calculateScale = () => {
            const screenWidth = window.innerWidth;
            return pdf.getPage(1).then(page => {
              const originalWidth = page.getViewport({ scale: 1 }).width;
              // 基础缩放比例（让PDF宽度适配屏幕）
              const baseScale = screenWidth / originalWidth;
              // 乘以像素比，提升高清屏清晰度
              return baseScale * effectivePixelRatio;
            });
          };
          
          calculateScale().then(scale => {
            for (let i = 1; i <= pdf.numPages; i++) {
              pdf.getPage(i)
                .then(page => {
                  const viewport = page.getViewport({ scale });
                  const canvas = document.createElement('canvas');
                  const context = canvas.getContext('2d');
                  
                  // 关键优化：设置canvas实际像素尺寸（乘以像素比）
                  canvas.width = viewport.width;
                  canvas.height = viewport.height;
                  
                  // CSS尺寸保持100%，让高像素canvas压缩显示，提升清晰度
                  canvas.style.width = `${viewport.width / effectivePixelRatio}px`;
                  canvas.style.height = `${viewport.height / effectivePixelRatio}px`;
                  
                  canvas.title = `第 ${i} 页`;
                  viewer.appendChild(canvas);
                  
                  // 渲染页面
                  const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                  };
                  
                  return page.render(renderContext).promise;
                })
                .catch(err => {
                  console.error(`第${i}页渲染失败:`, err);
                  const errorEl = document.createElement('div');
                  errorEl.className = 'error';
                  errorEl.textContent = `第${i}页加载失败`;
                  viewer.appendChild(errorEl);
                });
            }
          });
        })
        .catch(err => {
          console.error('PDF文件加载失败:', err);
          let errorMessage = 'PDF文件加载失败，请检查网络连接或文件是否存在';
          
          if (err.name === 'MissingPDFException') {
            errorMessage = '未找到PDF文件，请确认文件路径是否正确';
          } else if (err.name === 'InvalidPDFException') {
            errorMessage = 'PDF文件损坏或格式不正确';
          } else if (err.message.includes('CORS')) {
            errorMessage = '跨域访问被阻止，请检查服务器配置';
          }
          
          viewer.innerHTML = `<div class="error">${errorMessage}</div>`;
        });
    }
  </script>
</body>
</html>
